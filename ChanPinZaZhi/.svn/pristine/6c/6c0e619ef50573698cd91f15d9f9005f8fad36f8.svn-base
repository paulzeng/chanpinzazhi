package com.chanpinzazhi.ui;

import java.util.Map;

import org.ksoap2.serialization.SoapObject;
import org.ksoap2.serialization.SoapSerializationEnvelope;

import android.annotation.SuppressLint;
import android.app.Dialog;
import android.content.Intent;
import android.os.Bundle;
import android.os.Handler;
import android.os.Message;
import android.view.View;
import android.view.View.OnClickListener;
import android.view.Window;
import android.widget.ImageView;
import android.widget.LinearLayout;
import android.widget.TextView;

import com.chanpinzazhi.R;
import com.chanpinzazhi.adapter.ViewFlowAdapter;
import com.chanpinzazhi.manager.DeviceManager;
import com.chanpinzazhi.manager.L;
import com.chanpinzazhi.manager.NetManager;
import com.chanpinzazhi.manager.PreferenceManager;
import com.chanpinzazhi.manager.TitleManager;
import com.chanpinzazhi.manager.ToastManager;
import com.chanpinzazhi.manager.UIManager;
import com.chanpinzazhi.manager.XmlParseManager;
import com.chanpinzazhi.soap.SoapConstants;
import com.chanpinzazhi.soap.SoapHttpRequest;
import com.chanpinzazhi.view.CircleFlowIndicator;
import com.chanpinzazhi.view.ViewFlow;

@SuppressLint("HandlerLeak")
public class MainActivity extends BaseActivity implements OnClickListener {
	private static final String TAG = "MainActivity";
	private ImageView setting_btn;
	SoapObject rpc;
	SoapSerializationEnvelope envelope;
	boolean flag;
	// private ProgressBar spinner;
	private TextView main_column, tv_main_desc;
	private LinearLayout main_columnname;
	private boolean pushcheck;
	private ViewFlow viewFlow; // 进行图片轮播的viewFlow

	@Override
	protected void onCreate(Bundle savedInstanceState) {
		requestWindowFeature(Window.FEATURE_NO_TITLE);
		super.onCreate(savedInstanceState);
		setContentView(R.layout.activity_main);
		TitleManager.showTitle(this, new int[] { 2 }, R.string.appname);
		initOption();
		initView();
		initFlow();
		// 从网络获取数据
		initData();
	}

	private void initView() {
		main_column = (TextView) findViewById(R.id.main_column);
		main_column.setOnClickListener(this);
		tv_main_desc = (TextView) findViewById(R.id.tv_main_desc);
		main_columnname = (LinearLayout) findViewById(R.id.main_columnname);
		main_columnname.setOnClickListener(this);
		setting_btn = (ImageView) findViewById(R.id.btn_setting);
		setting_btn.setOnClickListener(this);
	}

	void initFlow() {
		viewFlow = (ViewFlow) this.findViewById(R.id.viewflow);// 获得viewFlow对象
		viewFlow.setAdapter(new ViewFlowAdapter(this)); // 对viewFlow添加图片
		viewFlow.setmSideBuffer(3);
		CircleFlowIndicator indic = (CircleFlowIndicator) this
				.findViewById(R.id.viewflowindic); // viewFlow下的indic
		viewFlow.setFlowIndicator(indic);

		viewFlow.setTimeSpan(3000);
		viewFlow.setSelection(3 * 1000); // 设置初始位置
		viewFlow.startAutoFlowTimer(); // 启动自动播放
	}

	void initData() {
		if (NetManager.isNetworkConnected(this)) {
			// 检测新的版本
			// UpdateManager manager = new UpdateManager(this);
			// manager.checkUpdate();
			SoapHttpRequest mrequest = new SoapHttpRequest(this);
			mrequest.GetAPPConfig(SoapConstants.GEAPPCONFIG, this, mHandler,
					"11164");
			// 开启消息推送
			pushcheck = PreferenceManager.getBoolean(this, "pushcheck");
			if (pushcheck) {
				Intent intent = new Intent();
				intent.setAction("com.chanpinzazhi.pushservice");
				intent.putExtra("status", 1);
				sendOrderedBroadcast(intent, null);
			}

			if (PreferenceManager.getString(this, "_id", "").equals("")) {// 没有请求过
				SoapHttpRequest request = new SoapHttpRequest(this);
				request.getNavByTableId(SoapConstants.GETBYTABLEID, this,
						mHandler, DeviceManager.getMyUUID(this), 4, 8,
						"[Id],[App_Name],[App_Description]", "[App_IsShow]=1",
						"[Order] DESC", 0, 1, "", false, "2014-04-10 08:55:00");
			} else {// 已经请求过
				String nav_name = PreferenceManager.getString(this,
						"_nav_name", "");
				main_column.setText(nav_name);
				String main_desc = PreferenceManager.getString(this,
						"_nav_desc", "进入");
				tv_main_desc.setText(main_desc);
			}
		} else {// 没有网络
			if (PreferenceManager.getString(this, "_id", "").equals("")) {// 没有请求过
				ToastManager.show(MainActivity.this, "亲，没有网络,请先检查网络");
				String nav_name = PreferenceManager.getString(this,
						"_nav_name", "栏目名称");
				main_column.setText(nav_name);
			} else {// 已经请求过
				ToastManager.show(MainActivity.this, "亲，没有网络,进行离线浏览模式");
				String nav_name = PreferenceManager.getString(this,
						"_nav_name", "");
				main_column.setText(nav_name);
				String main_desc = PreferenceManager.getString(this,
						"_nav_desc", "进入");
				tv_main_desc.setText(main_desc);
			}
		}
	}

	@Override
	public void onClick(View view) {
		switch (view.getId()) {
		case R.id.btn_setting:
			UIManager.switcher(this, SettingActivity.class);
			break;

		case R.id.main_column:
			Intent intent = new Intent(this, ProductActivity.class);
			startActivity(intent);
			overridePendingTransition(R.anim.in_from_bottom, R.anim.out_of_top);
			break;

		case R.id.main_columnname:
			Intent intent2 = new Intent(this, ProductActivity.class);
			startActivity(intent2);
			overridePendingTransition(R.anim.in_from_bottom, R.anim.out_of_top);
			break;
		default:
			break;
		}
	}

	private Handler mHandler = new Handler() {
		@Override
		public void handleMessage(Message msg) {
			switch (msg.what) {
			case SoapConstants.FAIL_RESULT:
			case SoapConstants.NO_NET:
				L.e(TAG, "网络不给力，请稍后重试");
				break;
			case SoapConstants.FAIL_XML_RESULT:
				L.e(TAG, "字段解析出错");
				break;
			case SoapConstants.TIMEOUT_RESULT:
				ToastManager.show(MainActivity.this, "请求超时");
				break;
			case SoapConstants.GETBYTABLEID:// 成功
				if (msg.obj == null) {
					ToastManager.show(MainActivity.this, "网络出了问题，请稍后再试...");
				} else {
					String result = msg.obj.toString();
					L.e(TAG, "栏目结果==" + result);
					try {
						Map<String, String> map = XmlParseManager
								.parseNav(result);
						if (map.get("Number").equals("1")) {
							PreferenceManager.setString(MainActivity.this,
									"_id", map.get("_id"));
							PreferenceManager.setString(MainActivity.this,
									"_nav_name", map.get("_name"));
							main_column.setText(map.get("_name"));

							PreferenceManager.setString(MainActivity.this,
									"_nav_desc", map.get("_desc"));
							tv_main_desc.setText(map.get("_desc"));
						} else if (map.get("Number").equals("-1006")) {
							ToastManager.show(MainActivity.this, "无效的站点ID");
						} else if (map.get("Number").equals("-1200")) {
							Dialog mDialog = UIManager
									.getCommWarnDialog2(MainActivity.this);
							mDialog.show();
						}
					} catch (Exception e) {
						// TODO Auto-generated catch block
						e.printStackTrace();
					}
				}
				break;
			case SoapConstants.GEAPPCONFIG:// 成功
				if (msg.obj == null) {
					ToastManager.show(MainActivity.this, "网络出了问题，请稍后再试...");
				} else {
					String config_result = msg.obj.toString();
					L.e(TAG, "获取appconfig结果==" + config_result);
					try {
						Map<String, String> map = XmlParseManager
								.parseAppConfig(config_result);
						if (map.get("Number").equals("1")) {
							String version = map.get("version");
							ToastManager.show(MainActivity.this, "最新的版本:"
									+ version);
						} else if (map.get("Number").equals("-1006")) {
							ToastManager.show(MainActivity.this, "无效的站点ID");
						} else if (map.get("Number").equals("-1200")) {
							Dialog mDialog = UIManager
									.getCommWarnDialog2(MainActivity.this);
							mDialog.show();
						}
					} catch (Exception e) {
						// TODO Auto-generated catch block
						e.printStackTrace();
					}
				}
				break;
			case SoapConstants.LOADING: {

				break;
			}

			default:
				break;
			}
		}
	};
}
